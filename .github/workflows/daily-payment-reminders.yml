name: Send Daily Payment Reminders

on:
  schedule:
    - cron: "0 9 * * *"

  workflow_dispatch:

jobs:
  send-reminders:
    name: Send Payment Reminders
    runs-on: ubuntu-latest

    steps:
      - name: Send Payment Reminder Emails
        run: |
          echo "ğŸš€ Triggering payment reminder emails..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.NETLIFY_FUNCTION_URL }}/send-payment-reminders" \
            -H "Content-Type: application/json" \
            -d '{}')

          # Extract HTTP code (last line) and response body
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)

          echo "ğŸ“¡ HTTP Status: $http_code"
          echo "ğŸ“„ Response:"
          echo "$response_body" | jq '.' || echo "$response_body"

          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Error: HTTP $http_code"
            exit 1
          fi

          # Parse and display results
          echo "$response_body" | jq -r '
            if .success then
              "âœ… Success: " + .message + 
              "\nğŸ“§ Emails sent: " + (.emailsSent // 0 | tostring) + 
              "\nâŒ Emails failed: " + (.emailsFailed // 0 | tostring)
            else
              "âŒ Failed: " + (.error // "Unknown error")
            end
          ' || echo "âœ… Payment reminders processed successfully"

      - name: Log Completion
        if: always()
        run: |
          echo "ğŸ Payment reminder job completed at $(date -u)"
          echo "â° Next scheduled run: Tomorrow at 9:00 AM UTC"
